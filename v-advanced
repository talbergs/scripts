#!/bin/bash

# Advanced Neovim in Docker wrapper with one-to-one path mapping
# This version mounts the host directory to the SAME path in the container
# Useful for: LSP servers, absolute paths in errors, git submodules
# Trade-off: Requires creating directory structure in container

set -e

IMAGE_NAME="neovim-nix:latest"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Check if Docker is available
if ! command -v docker &> /dev/null; then
    echo "âŒ Docker is not available. Please ensure Docker is running."
    exit 1
fi

# Check if image exists, build if not
if ! docker image inspect "$IMAGE_NAME" &> /dev/null; then
    echo "ðŸ“¦ Image '$IMAGE_NAME' not found. Building..."
    cd "$SCRIPT_DIR"
    ./build-neovim-docker.sh
    if [ $? -ne 0 ]; then
        echo "âŒ Failed to build image"
        exit 1
    fi
fi

# Get the current working directory
HOST_PWD="$(pwd)"

# One-to-one path mapping strategy
# Mount the current directory to the same absolute path in the container
CONTAINER_WORKDIR="$HOST_PWD"
PARENT_DIR="$(dirname "$HOST_PWD")"

# We need to create the parent directory structure in the container
# We do this by running a setup command first
MOUNT_ARGS="-v ${HOST_PWD}:${HOST_PWD}"

# Process file arguments
CONTAINER_ARGS=()
for arg in "$@"; do
    if [[ "$arg" == /* ]]; then
        # Absolute path - check if it's accessible
        if [[ -e "$arg" ]]; then
            # Check if path is under current directory
            if [[ "$arg" == ${HOST_PWD}/* ]]; then
                # Within mounted path - use as-is
                CONTAINER_ARGS+=("$arg")
            else
                # Outside current directory - need additional mount
                ARG_DIR="$(dirname "$arg")"
                ARG_FILE="$(basename "$arg")"
                MOUNT_ARGS="$MOUNT_ARGS -v ${ARG_DIR}:${ARG_DIR}:ro"
                CONTAINER_ARGS+=("$arg")
                echo "â„¹ï¸  Mounting additional path: $ARG_DIR (read-only)"
            fi
        else
            # File doesn't exist yet - assume it's in PWD
            CONTAINER_ARGS+=("$arg")
        fi
    else
        # Relative path - use as-is
        CONTAINER_ARGS+=("$arg")
    fi
done

# If no arguments, open current directory
if [ ${#CONTAINER_ARGS[@]} -eq 0 ]; then
    CONTAINER_ARGS+=(".")
fi

# Run Neovim in Docker with one-to-one path mapping
exec docker run -it --rm \
    -w "$CONTAINER_WORKDIR" \
    $MOUNT_ARGS \
    -e "TERM=${TERM:-xterm-256color}" \
    --entrypoint /bin/sh \
    "$IMAGE_NAME" \
    -c "mkdir -p '$PARENT_DIR' 2>/dev/null || true; exec /usr/local/neovim/bin/nvim ${CONTAINER_ARGS[*]}"
