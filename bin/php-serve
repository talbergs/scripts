#!/usr/bin/env bash
# brew link --overwrite php@8.4
# brew link --overwrite php@8.5

if [ ! -f ./index.php ]
then
    echo No index.php file in $PWD
    exit 1
fi

dbname=$(cd ..;basename $PWD | sed 's/[^[:alnum:]]//g')
read -p "DEV_DBNAME = $dbname, ok?"

if [ ! -f ./conf/zabbix.conf.php ]
then
    (
        cd ..
        $SCRIPTS_DIR/bin/apply-database "$dbname"
    )
    echo "<?php define('DEV_DBNAME', '$dbname');
        \$DB['TYPE'] = ZBX_DB_POSTGRESQL;
        \$DB['DATABASE'] = DEV_DBNAME;
        \$DB['USER'] = DEV_DBNAME;
        \$DB['PASSWORD'] = DEV_DBNAME;
    " > ./conf/zabbix.conf.php
fi

# PID file management
PORT=${1:-8888}
PIDFILE="/tmp/php-serve-${PORT}.pid"

# Check if PID file exists for this PORT
if [ -f "$PIDFILE" ]; then
    OLD_PID=$(cat "$PIDFILE")
    
    # Check if process is still running
    if ps -p "$OLD_PID" > /dev/null 2>&1; then
        echo "PHP server is already running on port $PORT (PID: $OLD_PID)"
        echo "To kill the process, run: kill $OLD_PID"
        echo "Or to force kill: kill -9 $OLD_PID"
        exit 1
    else
        echo "Stale PID file found (process $OLD_PID no longer exists), removing..."
        rm -f "$PIDFILE"
    fi
fi

# Start PHP server in background momentarily to capture PID
php -S 0.0.0.0:${PORT} \
    -d post_max_size=16M \
    -d max_execution_time=300 \
    \
    -d error_log=/tmp/php.error.log \
    -d date.timezone=Europe/Riga \
    -d error_reporting=E_ALL \
    -d log_errors=On \
    -d memory_limit=4G &

# Save the PID
PHP_PID=$!
echo $PHP_PID > "$PIDFILE"

echo "PHP server started on port $PORT (PID: $PHP_PID)"
echo "PID file: $PIDFILE"

# Wait in foreground
wait $PHP_PID

# Clean up PID file when server stops
rm -f "$PIDFILE"
